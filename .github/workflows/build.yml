name: Build Action

on:
  workflow_call:

jobs:
  check-go-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Check go.mod version is N-2 or older
        run: |
          LATEST=$(curl -s 'https://go.dev/dl/?mode=json' | jq -r '.[0].version' | sed 's/go//')
          LATEST_MINOR=$(echo "$LATEST" | cut -d. -f2)
          MAX_ALLOWED_MINOR=$((LATEST_MINOR - 2))

          GOMOD_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          GOMOD_MINOR=$(echo "$GOMOD_VERSION" | cut -d. -f2)

          echo "Latest Go: 1.${LATEST_MINOR}, max allowed in go.mod: 1.${MAX_ALLOWED_MINOR}, current go.mod: ${GOMOD_VERSION}"

          if [ "$GOMOD_MINOR" -gt "$MAX_ALLOWED_MINOR" ]; then
            echo "::error::go.mod declares go ${GOMOD_VERSION} but policy requires <= 1.${MAX_ALLOWED_MINOR} (N-2 of 1.${LATEST_MINOR})"
            exit 1
          fi

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        go-version: ["1.24", "1.25", "1.26"]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache-dependency-path: go.sum
      - name: Installing Dependencies
        run: make deps
      - name: Running format
        run: make format
      - name: Running lint
        run: make lint
      - name: Running tests
        run: make test
      - name: Ensure examples can be built
        run: make example
      - name: Checking uncommitted changes
        run: |
          git status -s > /tmp/git-status.log
          if [ -s /tmp/git-status.log ] ; then
            echo There are uncommitted changes
            cat /tmp/git-status.log
            false
          fi

  build-complete:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [check-go-version, build]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.check-go-version.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ]; then
            echo "::error::One or more jobs failed"
            exit 1
          fi
